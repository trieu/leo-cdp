<style>
<!--
	#attribution_description {
	    text-align: center;
	    font-size: 18px;
	    width: 100%;
	    font-weight: bold;
	}
	.user_profile_attrs {
	    background-color: #463CC4;
	    width: 50px;
	    height: 20px;
	    display: inline;
	}
	.persona_profile_attrs {
	    background-color: #E91E0D;
	    width: 50px;
	    height: 20px;
	    display: inline;
	}
	#attribution_description {
	    text-align: center;
	    font-size: 18px;
	    width: 80%;
	    margin:auto;
	    font-weight: bold;
	}
-->
</style>


<div>
     <div class="col-md-9" >
 		<h4 class="page-header" id="page_breadcrumb" > </h4>
 	 </div> 
     <div class="col-lg-3 text-center" style="padding: 10px">
     	<button type="button" class="btn btn-success" onclick="editCurrentProfile()" > Edit </button>
      	<button type="button" class="btn btn-danger" onclick="removeCurrentProfile()" > Remove </button>
     </div>
</div>

<div class="container-fluid" id="page_data_holder" >

       <!-- MAIN BODY here -->

       <div class="row">
           <div class="col-md-5">
           	   <ul class="nav nav-tabs" data-tab-content="profile_summary_tabs" >
		       	  <li class="active" > <a href="javascript:" data-target-tab="panel_profile_summary" > Profile summary </a> </li>
		       	  <li> <a href="javascript:" data-target-tab="panel_last_session_details" > Last session details</a> </li>
			   </ul>
			   <div class="tab-content" id="profile_summary_tabs" >

			    	<!-- tab 1  -->
			    	<div class="tab-pane active" id="panel_profile_summary" >
			     		<table border=0 class="underlined" style="width: 100%;">
		                   <tr>
		                       <td>
		                           <ol id="visitor_attributes" data-field="visitor_attributes">
		                               <li>
		                                   <b> Profile ID </b> 
		                                   <p data-field="id" data-fieldholder="html"  data-fieldtype="string"  > </p>
		                               </li>
		                               <li>
		                                   <b> Profile Type </b> 
		                                   <p data-field="typeAsText" data-fieldholder="html"  data-fieldtype="string"  > CRM_CONTACT </p>
		                               </li>
		                               <li>
		                                   <b> Creation Date </b> 
		                                   <p data-field="createdAt" data-fieldholder="html"  data-fieldtype="date"  > 2020-06-11 09:35:37  </p>
		                               </li>
		                               <li>
		                                   <b> Modification Date </b> 
		                                   <p data-field="updatedAt" data-fieldholder="html"  data-fieldtype="date"  > 2020-06-11 09:35:37  </p>
		                               </li>
		                               <li>
		                                   <b> Data Completion Score </b> 
		                                   <p data-field="dataCompletionScore" data-fieldholder="html"  data-fieldtype="int"  > 80 </p>
		                               </li>
		                                <li>
		                                   <b> Business Credit Score </b> 
		                                   <p data-field="businessCreditScore" data-fieldholder="html"  data-fieldtype="int"  > 80 </p>
		                               </li>
		                               <li>
		                                   <b> Customer Satisfaction Score </b> 
		                                   <p data-field="satisfactionScore" data-fieldholder="html"  data-fieldtype="int"  > 80 </p>
		                               </li>
		                               <li>
		                                   <b> Customer Lifetime Value in {{currency_code}}</b> 
		                                   <p data-field="totalCLV" data-fieldholder="html"  data-fieldtype="int"  > 10,000,000 </p>
		                               </li>
		                               
		                           </ol>
		                       </td>
		                   </tr>
		               </table>
					</div>
					
					<!-- tab 2  -->
       				<div class="tab-pane " id="panel_last_session_details" >
			     		 <table border=0 class="underlined" style="width: 100%;">
		                   <tr>
		                       <td>
		                           <ol id="visitor_attributes" data-field="visitor_attributes">
		                               <li>
		                                   <b> Last seen at the touchpoint name </b> 
		                                   <p data-field="lastTouchpoint.name" data-fieldholder="html"  data-fieldtype="string"  >   </p>
		                               </li>
		                               <li>
		                                   <b> Last seen at the touchpoint url </b> 
		                                   <p data-field="lastTouchpoint.url" data-fieldholder="html"  data-fieldtype="string"  >   </p>
		                               </li>
		                               <li>
		                                   <b> Last seen at the location </b> 
		                                   <p> TP.HCM, Việt Nam  </p>
		                               </li>
		                               <li>
		                                   <b> Session length </b> 
		                                   <p> 12 minutes  </p>
		                               </li>
		                               <li>
		                                   <b> Device ID </b> 
		                                   <p> dsadsa231 </p>
		                               </li>
		                               <li>
		                                   <b> Browser </b> 
		                                   <p> Safari  </p>
		                               </li>
		                               <li>
		                                   <b> Device type</b> 
		                                   <p> iPhone 7  </p>
		                               </li>
		                               <li>
		                                   <b> Device OS </b> 
		                                   <p> iOS 11  </p>
		                               </li>
		                           </ol>
		                       </td>
		                   </tr>
		               </table>
					</div>
					
           		</div>
           </div>
           
           <div class="col-md-7">
                <div class="row">
	               <div class="text-center" >
	                   <img src="https://randomuser.me/api/portraits/men/90.jpg"
	                       alt="Profile Avatar" class="rounded mx-auto d-block avatar">
	               </div>
                </div>
             
               <h4> Personal information </h4>
               
               <table border=0 class="underlined" style="width: 100%;">
                   <tr>
                       <td>
                           <ol id="personal_attributes" data-field="personal_attributes">
                           	   <li>
                                   <b data-persona="key" class="editable_text" > <i class="fa fa-fw fa-id-badge"></i> First name </b> 
                                   <p data-field="firstName" data-fieldholder="html"  data-fieldtype="string"  class="editable_text" >  - </p>
                               </li>
                               <li>
                                   <b data-persona="key" class="editable_text" > <i class="fa fa-fw fa-id-badge"></i> Last name </b> 
                                   <p data-field="lastName" data-fieldholder="html"  data-fieldtype="string"  >  - </p>
                               </li>
                               <li>
                                   <b data-persona="key" class="editable_text" > <i class="fa fa-fw fa-male"></i> Gender </b> 
                                   <p data-field="genderAsText" data-fieldholder="html"  data-fieldtype="string" > - </p>
                               </li>
                               <li>
                                   <b data-persona="key" class="editable_text" > <i class="fa fa-fw fa-user-circle-o"></i> Age </b> 
                                   <p data-field="age" data-fieldholder="html"  data-fieldtype="int"  > - </p> 
                               </li>
                               <li>
                                   <b data-persona="key" class="editable_text" > <i class="fa fa-fw fa-map-marker"></i> Living location  </b> 
                                   <p data-field="livingLocation" data-fieldholder="html"  data-fieldtype="string"  >  - </p>
                               </li>
                               <li>
                                   <b data-persona="key" class="editable_text" > <i class="fa fa-fw fa-envelope"></i> Primary email </b> 
                                   <p data-field="primaryEmail" data-fieldholder="html"  data-fieldtype="string"  >  - </p>
                               </li>
                               <li>
                                   <b data-persona="key" class="editable_text" >  <i class="fa fa-fw fa-mobile"></i> Primary mobile phone </b> 
                                   <p data-field="primaryPhone" data-fieldholder="html"  data-fieldtype="string"  > - </p>
                               </li>
                           </ol>
                       </td>
                   </tr>
               </table>
               
           </div>

       </div>
       
       <!--  Tab Navigation Items -->
       <ul class="nav nav-tabs" data-tab-content="profile_ext_data_tabs" >
       	  <li class="active" ><a href="javascript:" data-target-tab="panel_profile_business_data" > Business Data </a></li>
       	  <li ><a href="javascript:" data-target-tab="panel_profile_activitiy_flow" > Activity Flow </a></li>
       	  
		  <li style="display: none;" ><a href="javascript: " data-target-tab="panel_profile_journey" > Journey </a></li>
		  
		  <li style="display: none;" ><a href="javascript:" data-target-tab="panel_profile_ext_attributes" > Extended Attributes </a></li>
		  <li style="display: none;" ><a href="javascript:"data-target-tab="panel_business_transactions" > Business Transactions</a></li>
	   </ul>

	   <!-- Tab Contents  -->
       <div class="tab-content" id="profile_ext_data_tabs" >
       
       		<div class="tab-pane active" id="panel_profile_business_data" >
	     		<ul class="list-group list-group-dividered list-group-full">
				   <li class="list-group-item">
			            <h4 class="media-heading">viewed </h4>
			            <div>Lorem ipsum Veniam aliquip culpa laboris minim tempor labore
			               commodo officia veniam non in in in.
			            </div>
				   </li>
				   <li class="list-group-item">
			            <h4 class="media-heading">viewed </h4>
			            <div>Lorem ipsum Veniam aliquip culpa laboris minim tempor labore
			               commodo officia veniam non in in in.
			            </div>
				   </li>
				   
				</ul>
			</div>
			
		 	<div class="tab-pane " id="panel_profile_activitiy_flow" >
	     		<ul id="profile_activitiy_flow" class="list-group list-group-dividered list-group-full">
	     			<!-- data  -->
				</ul>
			</div>
			
			<div class="tab-pane" id="panel_profile_journey" style="display: none;" >
		     	<h4 id="journey_map_name" > Experience Journey Flow </h4>
		     	
		     	<div class="row">
		       		<div id="customerJourneyDiv" class="experience_journey_flow row" ></div>
		       	 	<div id="sankeyChart" style="height:580px; width:98%;"></div>
		       	</div>
		       	
		       	<div class="row" style="display: none;" >
		            <div class="col-md-6 bar-module">
		                <div id="venn_two" style=float:left>
		                    <h4 style="text-align: center">Media Touchpoints</h4>
		                </div>
		            </div>
		            <div class="col-md-6 ">
		                <div>
		                    <h4>Predictive Personality Traits(OCEAN Model) </h4>
		                </div>
		                <div class="pairs">
		                    <div id="chart_persornality">
		                    </div>
		                </div>
		            </div>
			     </div>   
			</div>
			
			<div class="tab-pane" id="panel_profile_ext_attributes" >
			      <h4>attributes</h4>
			      
			</div>
		    <div class="tab-pane" id="panel_business_transactions" >
		     	<h4>transactions</h4>
			</div>
	   </div>
       
       
       <div class="row" style="display: none;" >
       		<div class="line" ></div>
            <h4 style="text-align:center;width: 100%;">Customer Attribution Matrix of Profile and Persona </h4>

            <div id="attribution_description"></div> <br>
			
			<div class="row" >
				<div class="col-md-3 "></div>
				<div class="col-md-3 ">
	            	<div class="user_profile_attrs"> &nbsp; &nbsp; &nbsp; &nbsp; </div> &nbsp; are attributes of Customer Profile 
	            </div>
	            <div class="col-md-3 ">
	            	<div class="persona_profile_attrs"> &nbsp; &nbsp; &nbsp; &nbsp; </div> &nbsp; are attributes of Customer Persona 
				</div>
				<div class="col-md-3 "></div>
			</div>
			
            <div id="profile_attribution" class="col-md-12 bar-module" style="text-align: center;"></div>
       </div>
      
       <div class="line"></div>

</div>

<script id='tracking-event-tpl' type="text/html" >
<li class="list-group-item">
   <div class="row">
      <div class="col-md-1 text-center">  <i class="fa fa-arrow-right fa-2" aria-hidden="true" ></i> </div>
      <div class="col-md-11">
         <small class="text-muted pull-right"> <%- createdAt %> </small>
         <h4 class="media-heading"> <%- metricName %> </h4>
         <div> <a target="_blank" href="<%- srcTouchpoint.url %>" > <%- srcTouchpoint.name %> </a> </div>
      </div>
   </div>
</li>
</script>

<script type="text/javascript">
    ///Js code
    
    function initProfile360Analytics(profileId) {
    	console.log(profileId);
    	//setup editable node
		setupTabPanels();
		loadCurrentProfile(profileId)
    	
        setTimeout(function(){
        	//profilePathDiagram();
        	//loadProfileAttribution();
            //loadMediaTouchpoints();
            //personalityDiagram();
            
        },500);
    }
    
    function editCurrentProfile(){
    	gotoLeoCdpRouter('Customer_Profile_Editor', LeoCdpAdmin.routerContext.objId );
    }
    
    function removeCurrentProfile(){
    	alert('TODO')

    }
    
    function loadCurrentProfile(profileId) {
         console.log('loadCurrentProfile profileId ' + profileId);

         var urlStr = '/cdp/profile/get';
         var params = {
             'id': profileId
         };
         
         LeoCdpAdmin.loadDataAndUpdateView(urlStr, params, function(){
        	 console.log(LeoCdpAdmin.routerContext.dataObject);
        	 LeoAdminApiUtil.getSecuredData('/cdp/profile/tracking-events',{id:profileId,startIndex:0,numberResult:50},function(json){ 
        		 console.log(json.data) 
        		 eventTpl = _.template($('#tracking-event-tpl').html());
        		 var node = $('#profile_activitiy_flow');
        		 _.forEach(json.data,function(e,i){
        			 var html = eventTpl(e);
        			 node.append(html);
       			});
        	 })
         })
    }
    

    function profilePathDiagram() {
        var metricName = 'Reach'
        var journeyStages = ['Google Search', 'Facebook Group', 'YouTube channel', 'E-commerce Website', 'E-commerce Mobile App','Email khách hàng (CRM)','Số điện thoại khách hàng (CRM)','Cửa hàng bán lẻ','Shopping Mall']
        var journeyStageMetrics = { 'Mua hàng' : 'đơn hàng' }

        var configSankey = {
            margin: {
                top: 10,
                left: 10,
                right: 10,
                bottom: 10
            },
            nodes: {
                dynamicSizeFontNode: {
                    enabled: true,
                    minSize: 14,
                    maxSize: 30
                },
                fontSize: 14, // if dynamicSizeFontNode not enabled
                draggableX: false, // default [ false ]
                draggableY: true, // default [ true ]
                colors: d3.scaleOrdinal(d3.schemeCategory10)
            },
            links: {
                formatValue: function (name, val) {
                    //console.log('formatValue ' + name)
                    var label = journeyStageMetrics[name] ? journeyStageMetrics[name] : metricName
                    return d3.format(",.0f")(val) + ' ' + label;
                },
                unit: metricName // if not set formatValue function
            },
            tooltip: {
                infoDiv: true, // if false display default tooltip
                labelSource: 'Input:',
                labelTarget: 'Output:'
            }
        }
        var datajson = {
            nodes: [
                {
                    id: 0,
                    name: "Google Search"
                }, {
                    id: 1,
                    name: "Facebook Group"
                }, {
                    id: 2,
                    name: "YouTube channel",

                }, {
                    id: 3,
                    name: "E-commerce Website",
                }, {
                    id: 4,
                    name: "E-commerce Mobile App"
                }, {
                    id: 5,
                    name: "Email khách hàng (CRM)"
                }, {
                    id: 6,
                    name: "Số điện thoại khách hàng (CRM)"
                }, {
                    id: 7,
                    name: "Cửa hàng bán lẻ"
                }, {
                    id: 8,
                    name: "Shopping Mall"
                } , {
                    id: 9,
                    name: "Mua hàng"
                }
                ],
            links: [
                {
                    source: 0,
                    target: 3,
                    value: 1
                },
                {
                    source: 1,
                    target: 3,
                    value: 1
                }, {
                    source: 2,
                    target: 3,
                    value: 1
                }, {
                    source: 0,
                    target: 4,
                    value: 1
                },
                {
                    source: 1,
                    target: 4,
                    value: 1
                }, {
                    source: 0,
                    target: 2,
                    value: 1
                } , {
                    source: 2,
                    target: 7,
                    value: 1
                }  , {
                    source: 5,
                    target: 4,
                    value: 1
                }
                , {
                    source: 6,
                    target: 4,
                    value: 1
                }
                , {
                    source: 2,
                    target: 7,
                    value: 1
                } , {
                    source: 2,
                    target: 8,
                    value: 1
                } , {
                    source: 8,
                    target: 9,
                    value: 1
                } , {
                    source: 4,
                    target: 9,
                    value: 1
                }  , {
                    source: 3,
                    target: 9,
                    value: 1
                }  , {
                    source: 7,
                    target: 9,
                    value: 1
                } , {
                    source: 7,
                    target: 4,
                    value: 1
                }
                ]
        };

        var objSankey = sk.createSankey('#sankeyChart', configSankey, datajson);
    }
    
    function loadMediaTouchpoints() {
        var sets = [{
            sets: ["Email"],
            figure: 27.92,
            label: "Email",
            size: 27.92
        }, {
            sets: ["Direct Traffic"],
            figure: 55.28,
            label: "Direct Traffic",
            size: 55.28
        }, {
            sets: ["Search Engine"],
            figure: 7.62,
            label: "Search Engine",
            size: 7.62
        }, {
            sets: ["Email", "Direct Traffic"],
            figure: 3.03,
            label: "Email and Direct Traffic",
            size: 3.03
        }, {
            sets: ["Email", "Search Engine"],
            figure: 1.66,
            label: "Email and Search Engine",
            size: 1.66
        }, {
            sets: ["Direct Traffic", "Search Engine"],
            figure: 2.4,
            label: "Direct Traffic and Search Engine",
            size: 2.4
        }, {
            sets: ["Email", "Direct Traffic", "Search Engine"],
            figure: 1.08,
            label: "Email, Direct Traffic, and Search Engine",
            size: 1.08
        }];

        var chart = venn
            .VennDiagram()
            .width(500)
            .height(400);

        var div2 = d3
            .select("#venn_two")
            .datum(sets)
            .call(chart);
        div2.selectAll("text").style("fill", "white");
        div2
            .selectAll(".venn-circle path")
            .style("fill-opacity", 0.8)
            .style("stroke-width", 1)
            .style("stroke-opacity", 1)
            .style("stroke", "fff");

        var tooltip = d3
            .select("body")
            .append("div")
            .attr("class", "venntooltip");

        div2
            .selectAll("g")
            .on("mouseover", function (d, i) {
                // sort all the areas relative to the current item
                venn.sortAreas(div2, d);

                // Display a tooltip with the current size
                tooltip
                    .transition()
                    .duration(40)
                    .style("opacity", 1);
                tooltip.text(d.size + "% media touchpoint " + d.label);

                // highlight the current path
                var selection = d3
                    .select(this)
                    .transition("tooltip")
                    .duration(400);
                selection
                    .select("path")
                    .style("stroke-width", 3)
                    .style("fill-opacity", d.sets.length == 1 ? 0.8 : 0)
                    .style("stroke-opacity", 1);
            })

            .on("mousemove", function () {
                tooltip
                    .style("left", d3.event.pageX + "px")
                    .style("top", d3.event.pageY - 28 + "px");
            })

            .on("mouseout", function (d, i) {
                tooltip
                    .transition()
                    .duration(2500)
                    .style("opacity", 0);
                var selection = d3
                    .select(this)
                    .transition("tooltip")
                    .duration(400);
                selection
                    .select("path")
                    .style("stroke-width", 3)
                    .style("fill-opacity", d.sets.length == 1 ? 0.8 : 0)
                    .style("stroke-opacity", 1);
            });
    }

    function personalityDiagram() {
        var width = 300,
            height = 300;

        // Config for the Radar chart
        var config = {
            w: width,
            h: height,
            maxValue: 100,
            levels: 5,
            ExtraWidthX: 300
        }

        var data = [
            [{
                "area": "Openness",
                "value": 80
            }, {
                "area": "Conscientiousness",
                "value": 40
            }, {
                "area": "Extraversion ",
                "value": 40
            }, {
                "area": "Agreeableness ",
                "value": 90
            }, {
                "area": "Neuroticism ",
                "value": 60
            }]
        ]

        //Call function to draw the Radar chart

        var svg = d3.select('chart_persornality')
            .append('svg')
            .attr("width", width)
            .attr("height", height);

        RadarChart.draw("#chart_persornality", data, config);
    }
    
    function loadProfileAttribution() {
        // set the dimensions and margins of the graph
        var containerW = Math.round($("#profile_attribution").width())
        var margin = { top: 30, right: 60, bottom: 100, left: 140 },
            width = containerW - margin.left - margin.right,
            height = 550 - margin.top - margin.bottom;

        // append the svg object to the body of the page
        var svg = d3.select("#profile_attribution")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        // Labels of row and columns
    
        var myGroups = ["Live_in_Saigon", "Visited_Web", "Installed_App", "Used_Credit_Card","Buy_Product"]
        var myVars = ["Buy_Product", "Used_Credit_Card", "Installed_App",  "Visited_Web", "Live_in_Saigon" ]

        // Build X scales and axis:
        var x = d3.scaleBand()
            .range([0, width])
            .domain(myGroups)
            .padding(0.01);
        svg.append("g")
            .attr("transform", "translate(0," + height + ")")
            .attr("class", "x_axis")
            .call(d3.axisBottom(x))
            .selectAll("text")
            .attr("transform", "translate(-10,10)rotate(-30)")
            .style("text-anchor", "end")
            .style("font-size", 15)
            .style("fill", "#E91E0D");

        // Build X scales and axis:
        var y = d3.scaleBand()
            .range([height, 0])
            .domain(myVars)
            .padding(0.01);
        svg.append("g")
            .attr("class", "y_axis")
            .call(d3.axisLeft(y))
            .selectAll("text")
            .style("text-anchor", "end")
            .style("font-size", 15)
            .style("fill", "#463CC4")
            ;

        // Build color scale
        var myColor = d3.scaleLinear()
            .range(["white", "#008748"])
            .domain([1, 100]);
        
        function select_axis_label(datum) {
            return d3.select('.x_axis')
            	.selectAll('text')
            	.filter(function(x) { return x == datum.letter; });
        }

        //Read the data
        var urlDataSource = "/public/uploaded-files/sample-profile-attribution.csv?_=" + new Date().getTime();
        d3.csv(urlDataSource, function (data) {
        	
            // Three function that change the tooltip when user hover / move / leave a cell

            var onclick = function (d) {
            	var str = " [Profile attribute: " + d.profile_attr + " - Persona attribute: " + d.persona_attr + "] : Matching Score = " + d.matching_score + " %";
                $('#attribution_description').text(str);
                var myNode = svg.select("#cell_"+ d.profile_attr + '_' + d.persona_attr);
            	
                var str = " [Profile attribute: " + d.profile_attr + " - Persona attribute: " + d.persona_attr + "] : Matching Score = " + d.matching_score + " %";
                $('#attribution_description').text(str).effect("highlight", {color:"#5eeb34"}, 6000 );
            }
           
            var mouseover = function (d) {
            	console.log(d)
            	var myNode = svg.select("#cell_"+ d.profile_attr + '_' + d.persona_attr);
            	myNode.style("fill", "#5eeb34");
            	
            	var str = " [Profile attribute: " + d.profile_attr + " - Persona attribute: " + d.persona_attr + "] : Matching Score = " + d.matching_score + " %";
                $('#attribution_description').text(str);
            }
            
            var mouseout = function(d) {
           		var myNode = svg.select("#cell_"+ d.profile_attr + '_' + d.persona_attr);
               	myNode.style("fill", myColor(d.matching_score) );
            }

            // add the squares
            svg.selectAll()
                .data(data, function (d) { return d.profile_attr + ':' + d.persona_attr; })
                .enter()
                .append("rect")
                .attr("id", function (d) { return "cell_"+ d.profile_attr + '_' + d.persona_attr })
                .attr("x", function (d) { return x(d.profile_attr) } )
                .attr("y", function (d) { return y(d.persona_attr) } )
                .attr("width", x.bandwidth())
                .attr("height", y.bandwidth())
                .style("fill", function (d) { return myColor(d.matching_score)} )
                .on("click", onclick)
                .on("mouseover", mouseover)
                .on('mouseout', mouseout)
                ;
        })
    }
</script>
