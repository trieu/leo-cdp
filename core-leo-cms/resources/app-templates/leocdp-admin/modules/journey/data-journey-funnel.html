<div class="container-fluid">

    <div class="row">
        <div class="col-lg-12">
            <h4 class="page-header" id="page_breadcrumb" > </h4>
        </div>
    </div>

    <div class="row" >
  		<div class="row col-lg-12 text-center">
  			<div class="col-md-2"></div>
  			<div class="col-md-4">
                 <h4 class="chart_header text-center" >Behavioral Event Funnel</h4>
	           	 <div class="summary_metric">
	               <div class="vcenter">
	                  <div id="event_funnel"></div>
	               </div>
	           	</div>
             </div>
             <div class="col-md-4 ">
                 <h4 class="chart_header text-center" >Customer Data Funnel</h4>
                 <div class="summary_metric">
	               <div class="vcenter">
	                  <div id="profile_funnel"></div>
	               </div>
	           	</div>
             </div>
             <div class="col-md-2"></div>
        </div>
        
        <div class="col-lg-12" style="margin-top: 8px;">
         	<h4 class="text-center"> All tracking events in Customer Journey Funnel </h4>
            <div class="table-responsive">
                <div id="behavioral_metrics_table"></div>
            </div>
        </div>
    </div>

</div>

<script>
	var initBehavioralEventList = initBehavioralEventList || function(){
		
		var funnelOptions = {
		  		block: { highlight: true },
		        chart: {
		        	curve: { enabled: true, height: 20 },
		            bottomWidth : 0.52,
		            height: 280
		        },
		        tooltip: {
		            enabled: true
		        },
		        label: {
		            fontSize: '12px'
		        },
		        events: {
		            click: {
		                block: function (data) {
		                    console.log(data.label.raw);
		                }
		            }
		        }
		 };
	
	    var eventDataTypes = [
	        { name: "First-party Data", id: 1 },
	        { name: "Second-party Data", id: 2 },
	        { name: "Third-party Data", id: 3 }
	    ];
	
		function loadProfileFunnel() {
		    var data = [
		    	['Human Profile', '', '#78A8C9'],
		        ['Visitor', '', '#2980B9'],
		        ['Engaged Visitor', '', '#4C7DA3'],
		        ['Customer Lead', '', '#416E90'],
		        ['Prospective Customer', '', '#2874a6'],
		        ['First-time Customer', '', '#21618c'],
		        ['Customer Advocate', '', '#1b4f72'],
		        ['Repeat Customer', '', '#163247']
		    ];
		    var chart = new D3Funnel('#profile_funnel');
		    chart.draw(data, funnelOptions);
		}

		function loadEventFunnel() {
		    var data = [
		        ['Content View', '', '#719DBB'],
		        ['Product View', '', '#7395AD'],
		        ['Customer Login','', '#07689f'],
		        ['Purchase Intent', '', '#1e5f74'],
		        ['First Purchase', '', '#0f4c75'],
		        ['Product Experience', '', '#133b5c'],
		        ['Customer Feedback','', '#1b4f72'],
		        ['Repeat Purchase', '', '#1d2d50']
		    ];
		    var chart = new D3Funnel('#event_funnel');
		    chart.draw(data, funnelOptions);
		}
	
		loadProfileFunnel();
	    loadEventFunnel();
	    
	    LeoAdminApiUtil.getSecuredData('/cdp/funnels-and-event-metrics',{"funnelTypes":"event_retail,customer_retail"}, function(json){ 
			 //console.log(json.data);	
			 var canInsertData = json.canInsertData;
	    	 var canEditData = json.canEditData;
    		 var canDeleteData = json.canDeleteData;
			
			 if( ! canEditData ){
				$('button.data-control').attr('disabled','disabled');
			 }
			
			 var eventFunnelStages = json.data['event_retail'];
			 var customerFunnelStages = json.data['customer_retail'];
			 var behavioralMetricsData = json.data['behavioral_metrics'];
			 
			 $("#behavioral_metrics_table").jsGrid({
			    width: "100%",
			    height: "auto",
	
			    inserting: canInsertData,
			    editing: canEditData,
			    sorting: false,
			    paging: false,
			    
			    deleteConfirm: function(item) {
		            return "The event \"" + item.eventName + "\" will be removed. Are you sure?";
		        },
	
			    data: behavioralMetricsData,
			    
			    onItemInserting: function(args) {
			    	//console.log(args.item)
			    	
			    	// TODO Ajax submit data to backend here
			    	setTimeout(function(){
			    		args.item.id = "";
			    		//console.log(behavioralMetricsData)
			    	},1000);
			    	
			    },      
			    onItemInserted: function(args) {
			    	//console.log(args.item)
			    	//console.log(behavioralMetricsData)
			    }, 
			    onItemDeleting: function(args) {
			        console.log(args.item)
			    },
	
			    fields: [
			    	{ name: "score", title : "Score", type: "number", align: 'center',  width: 40, validate: "required" },
			        { name: "eventName", title : "Event Name", align: 'center' , type: "text", validate: "required" },
			        { name: "eventLabel", title : "Event Label", align: 'center' , type: "text" },
			        { name: "eventFunnelStageId", title : "Event Funnel Stage", type: "select", items: eventFunnelStages, valueField: "id", textField: "name" },
			        { name: "customerFunnelStageId", title : "Customer Funnel Stage", type: "select", items: customerFunnelStages, valueField: "id", textField: "name" },
			        { name: "dataType", type: "select", title : "Data Type", items: eventDataTypes, valueField: "id", textField: "name" },
			        { type: "control" , width: 50, deleteButton: canDeleteData}
			    ]
			});  
		});
	}

</script>