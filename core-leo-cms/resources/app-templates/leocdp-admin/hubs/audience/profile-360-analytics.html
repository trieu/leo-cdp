<style>
<!--
#attribution_description {
    text-align: center;
    font-size: 18px;
    width: 100%;
    font-weight: bold;
}
.user_profile_attrs {
    background-color: #463CC4;
    width: 50px;
    height: 20px;
    display: inline;
}
.persona_profile_attrs {
    background-color: #E91E0D;
    width: 50px;
    height: 20px;
    display: inline;
}
#attribution_description {
    text-align: center;
    font-size: 18px;
    width: 80%;
    margin:auto;
    font-weight: bold;
}

-->
</style>

<div class="row" id="breadcrumb_header" >
      	<div class="col-md-12" >
           <h2 class="page-header" > <a href="javascript:"> Audience Hub </a> 
           &#8594; <a href="#calljs-loadAudienceProfiles()"> Audience Profiles </a>
           &#8594; <a href="javascript:"> Profile 360 Analytics </a> </h2>
       </div>
       
   </div>

   <h2 id="journey_map_name" >Hành trình của khách hàng </h2>

   <div class="container-fluid">

       <!-- MAIN BODY here -->

       <div class="row">
           <div class="col-md-4">
               <div class="text-center">
                   <h3>Avatar</h3>
                   <img src="https://randomuser.me/api/portraits/men/90.jpg"
                       alt="Profile Avatar" class="rounded mx-auto d-block avatar">
               </div>
           </div>
           <div class="col-md-8">

               <div>
                   <h3> {{profile_full_name}} </h3>
                   <strong class="editable_text"> Nguyen Van A </strong>
               </div>
               <br>
               <h3> {{profile_attributes}}
                   <span class="editable_add_item" data-target="personal_attributes"  ></span>  
               </h3>
               <table border=0 class="underlined" style="width: 100%;">
                   <tr>
                       <td>
                           <ol id="personal_attributes" data-field="personal_attributes">
                               <li>
                                   <b data-persona="key" class="editable_text" > Giới tính </b> 
                                   <p data-persona="value" class="editable_text" > Nam </p>
                               </li>
                               <li>
                                   <b data-persona="key" class="editable_text" > Độ tuổi </b> 
                                   <p data-persona="value" class="editable_text" > 30 </p>
                               </li>
                               <li>
                                   <b data-persona="key" class="editable_text" > Vùng địa lý </b> 
                                   <p data-persona="value" class="editable_text" > TP.HCM, Việt Nam  </p>
                               </li>
                           </ol>
                       </td>
                   </tr>
               </table>
           </div>

       </div>
       
       
       <div class="row" style="display: none;" >
       		<div class="line" ></div>
            <h3 style="text-align:center;width: 100%;">Customer Attribution Matrix of Profile and Persona </h3>

            <div id="attribution_description"></div> <br>
			
			<div class="row" >
				<div class="col-md-3 "></div>
				<div class="col-md-3 ">
	            	<div class="user_profile_attrs"> &nbsp; &nbsp; &nbsp; &nbsp; </div> &nbsp; are attributes of Customer Profile 
	            </div>
	            <div class="col-md-3 ">
	            	<div class="persona_profile_attrs"> &nbsp; &nbsp; &nbsp; &nbsp; </div> &nbsp; are attributes of Customer Persona 
				</div>
				<div class="col-md-3 "></div>
			</div>
			
            <div id="profile_attribution" class="col-md-12 bar-module" style="text-align: center;"></div>
       </div>
       
       
       
       <br>
       <div class="line"></div>
       <div class="row">
       		<h3 style="text-align: center"> Customer Journey Map </h3>
       		<div id="customerJourneyDiv" class="experience_journey_flow row" ></div>
       	 	<div id="sankeyChart" style="height:580px; width:98%;"></div>
       </div>
       
       <br><br>
       <div class="line"></div>
       <div class="row" >
            <div class="col-md-6 bar-module">
                <div id="venn_two" style=float:left>
                    <h3 style="text-align: center">Media Touchpoints</h3>
                </div>
            </div>
            <div class="col-md-6 ">
                <div>
                    <h3>Predictive Personality Traits(OCEAN Model) </h3>
                </div>
                <div class="pairs">
                    <div id="chart_persornality">
                    </div>
                </div>
            </div>
       </div>

       <div class="row">

           <div class="col-md-6">
               <h3> {{profile_expectations}} 
                   <span class="editable_add_item" data-target="personal_expectations"  ></span>  
               </h3> 
               
               <table style="width: 100%;" class="plain">
                   <tr>
                       <td>
                           <ol id="personal_expectations" data-field="personal_expectations" >
                               <li>
                                   <p class="editable_text"> đọc thử nội dung trước khi mua  </p>
                               </li>
                               <li>
                                   <p class="editable_text"> kiến thức phù hợp thực tế </p>
                               </li>
                               <li>
                                   <p class="editable_text"> tăng doanh thu bán hàng online </p>
                               </li>
                           </ol>
                       </td>
                   </tr>
               </table>
           </div>

           <div class="col-md-6">
               <h3> {{profile_interests}}  
                   <span class="editable_add_item" data-target="personal_interests"  ></span>  
               </h3>
               <table style="width: 100%;" class="plain">
                   <tr>
                       <td>
                           <ol id="personal_interests" data-field="personal_interests" >
                               <li>
                                   <p class="editable_text"> học hỏi kiến thức mới về công nghệ </p>
                               </li>
                               <li>
                                   <p class="editable_text"> phát triển kinh doanh, doanh nghiệp </p>
                               </li>
                               <li>
                                   <p class="editable_text"> cảm thấy tự tin, đủ kiến thức cho công việc </p>
                               </li>

                           </ol>
                       </td>
                   </tr>
               </table>
           </div>

       </div>

       <div class="line"></div>

       <div class="row">

           <div class="col-md-6">
               <h3> {{profile_recommended_ideas}} 
                   <span class="editable_add_item" data-target="business_ideas"  ></span> 
               </h3>
               <table class="plain" style="width: 100%;">
                   <tr>
                       <td>
                           <ol id="business_ideas" data-field="business_ideas" >
                               <li>
                                   <p class="editable_text"> Chủ đề sách về marketing 4.0 </p>
                               </li>
                               <li>
                                   <p class="editable_text"> Chủ đề sách về nền tảng công nghệ (Technology Platform) </p>
                               </li>
                               <li>
                                   <p class="editable_text"> Chủ đề sách về nghệ thuật bán hàng online </p>
                               </li>
                           </ol>
                       </td>
                   </tr>
               </table>
           </div>

           <div class="col-md-6">
               <h3> {{profile_recommended_solutions}}
                   <span class="editable_add_item" data-target="business_solutions"  ></span> 
               </h3>
               <table class="plain" style="width: 100%;">
                   <tr>
                       <td>
                           <ol id="business_solutions" data-field="business_solutions" >
                               <li>
                                   <p class="editable_text"> Chạy marketing  "Marketing Cuộc Cách Mạng Công Nghệ 4.0" của Philip Kotler </p>
                               </li>
                               <li>
                                   <p class="editable_text"> Chạy marketing cuốn Platform Ứng Dụng </p>
                               </li>
                               <li>
                                   <p class="editable_text"> Tìm kiếm các chuyên gia và đặt hàng họ viết sách  </p>
                               </li>
                           </ol>
                       </td>
                   </tr>
               </table>
           </div>

       </div>

       <div class="line"></div>


       <div class="row">
           <div class="col-md-6">
               <h3> {{profile_touchpoints}}
                   <span class="editable_add_item" data-target="personal_touchpoints"  ></span>
               </h3>
               <table class="plain">
                   <tr>
                       <td>
                           <ol id="personal_touchpoints" data-field="personal_touchpoints" >
                            	<li>
                                   <p class="editable_text"> Google Search </p>
                               </li>
                               <li>
                                   <p class="editable_text"> Facebook Group </p>
                               </li>
                               <li>
                                   <p class="editable_text"> YouTube channel </p>
                               </li>
                               <li>
                                   <p class="editable_text"> E-commerce Website </p>
                               </li>
                               <li>
                                   <p class="editable_text"> E-commerce Mobile App </p>
                               </li>
                               <li>
                                   <p class="editable_text"> Email khách hàng (CRM) </p>
                               </li>
                               <li>
                                   <p class="editable_text"> Số điện thoại khách hàng (CRM) </p>
                               </li>
                               <li>
                                   <p class="editable_text"> Cửa hàng bán lẻ </p>
                               </li>
                               <li>
                                   <p class="editable_text"> Shopping Mall </p>
                               </li>
                           </ol>
                       </td>
                   </tr>
               </table>
           </div>
           <div class="col-md-6">
           	<h3> {{profile_actions}} <span class="editable_add_item" data-target="conversion_actions" ></span> </h3>
               <table class="plain" style="width: 100%;">
                   <tr>
                       <td>
                           <ol id="conversion_actions" data-field="conversion_actions" >
                               <li>
                                   <p class="editable_text"> Add To Cart </p>
                               </li>
                               <li>
                                   <p class="editable_text"> Ghé nhà sách </p>
                               </li>
                               <li>
                                   <p class="editable_text"> Đọc thử </p>
                               </li>
                           </ol>
                       </td>
                   </tr>
               </table>
           </div>
       </div>

   </div>
    <br><br><br><br>

<textarea id="customer_flow_code" style="display: none;" >
journey
    title Experience Flow
    section {{touchpoints_demand_generation}}
    	Google Search:3: Lead
      	Facebook Group:3: Lead
      	YouTube channel:3: Lead
      	Shopping Mall : 3: Lead
    section {{touchpoints_experience_for_lead}}
      	Website:3:  Lead
      	Mobile app:3:  Lead
      	Shopping Mall:3:  Lead
      	Cửa hàng bán lẻ:3:  Lead 
    section {{touchpoints_business_transaction}}
    	E-commerce Website:1: Customer
      	E-commerce Mobile App:4: Customer
      	Cửa hàng bán lẻ:5: Customer
      	Shopping Mall : 5: Customer
    section {{touchpoints_experience_for_customer}}
      	Website - Customer Support:3: Customer
      	Mobile App - Customer Support:4: Customer
      	Social Media Fan Page:4: Customer
      	Social Group:5: Customer
</textarea>

<script type="text/javascript">
    ///Js code

    
    function initProfile360Analytics() {
    	//setup editable node

        setTimeout(function(){
        	loadProfileAttribution();
            loadMediaTouchpoints()
            profilePathDiagram()
            personalityDiagram();
            renderCustomerJourney();
        },500);
    }
    
    function renderCustomerJourney(){
        // Example of using the API
        var placeholderSelector = "#customerJourneyDiv";
        var graphDefinition = $('#customer_flow_code').val().trim();
        $(placeholderSelector).find('div').remove();
      	
        var gid = "customer_graph_"+ new Date().getTime(); 
        graph = mermaid.mermaidAPI.render(gid, graphDefinition, function(svgCode, bindFunctions){
        	document.querySelector(placeholderSelector).innerHTML = '<div>'+svgCode+"</div>";
        });
    }

    function profilePathDiagram() {
        var metricName = 'Reach'
        var journeyStages = ['Google Search', 'Facebook Group', 'YouTube channel', 'E-commerce Website', 'E-commerce Mobile App','Email khách hàng (CRM)','Số điện thoại khách hàng (CRM)','Cửa hàng bán lẻ','Shopping Mall']
        var journeyStageMetrics = { 'Mua hàng' : 'đơn hàng' }

        var configSankey = {
            margin: {
                top: 10,
                left: 10,
                right: 10,
                bottom: 10
            },
            nodes: {
                dynamicSizeFontNode: {
                    enabled: true,
                    minSize: 14,
                    maxSize: 30
                },
                fontSize: 14, // if dynamicSizeFontNode not enabled
                draggableX: false, // default [ false ]
                draggableY: true, // default [ true ]
                colors: d3.scaleOrdinal(d3.schemeCategory10)
            },
            links: {
                formatValue: function (name, val) {
                    //console.log('formatValue ' + name)
                    var label = journeyStageMetrics[name] ? journeyStageMetrics[name] : metricName
                    return d3.format(",.0f")(val) + ' ' + label;
                },
                unit: metricName // if not set formatValue function
            },
            tooltip: {
                infoDiv: true, // if false display default tooltip
                labelSource: 'Input:',
                labelTarget: 'Output:'
            }
        }
        var datajson = {
            nodes: [
                {
                    id: 0,
                    name: "Google Search"
                }, {
                    id: 1,
                    name: "Facebook Group"
                }, {
                    id: 2,
                    name: "YouTube channel",

                }, {
                    id: 3,
                    name: "E-commerce Website",

                }, {
                    id: 4,
                    name: "E-commerce Mobile App"
                }, {
                    id: 5,
                    name: "Email khách hàng (CRM)"
                }, {
                    id: 6,
                    name: "Số điện thoại khách hàng (CRM)"
                }, {
                    id: 7,
                    name: "Cửa hàng bán lẻ"
                }, {
                    id: 8,
                    name: "Shopping Mall"
                } , {
                    id: 9,
                    name: "Mua hàng"
                }
                ],
            links: [
                {
                    source: 0,
                    target: 3,
                    value: 1
                },
                {
                    source: 1,
                    target: 3,
                    value: 1
                }, {
                    source: 2,
                    target: 3,
                    value: 1
                }, {
                    source: 0,
                    target: 4,
                    value: 1
                },
                {
                    source: 1,
                    target: 4,
                    value: 1
                }, {
                    source: 0,
                    target: 2,
                    value: 1
                } , {
                    source: 2,
                    target: 7,
                    value: 1
                }  , {
                    source: 5,
                    target: 4,
                    value: 1
                }
                , {
                    source: 6,
                    target: 4,
                    value: 1
                }
                , {
                    source: 2,
                    target: 7,
                    value: 1
                } , {
                    source: 2,
                    target: 8,
                    value: 1
                } , {
                    source: 8,
                    target: 9,
                    value: 1
                } , {
                    source: 4,
                    target: 9,
                    value: 1
                }  , {
                    source: 3,
                    target: 9,
                    value: 1
                }  , {
                    source: 7,
                    target: 9,
                    value: 1
                } , {
                    source: 7,
                    target: 4,
                    value: 1
                }
                ]
        };

        var objSankey = sk.createSankey('#sankeyChart', configSankey, datajson);
    }
    
    function loadMediaTouchpoints() {
        var sets = [{
            sets: ["Email"],
            figure: 27.92,
            label: "Email",
            size: 27.92
        }, {
            sets: ["Direct Traffic"],
            figure: 55.28,
            label: "Direct Traffic",
            size: 55.28
        }, {
            sets: ["Search Engine"],
            figure: 7.62,
            label: "Search Engine",
            size: 7.62
        }, {
            sets: ["Email", "Direct Traffic"],
            figure: 3.03,
            label: "Email and Direct Traffic",
            size: 3.03
        }, {
            sets: ["Email", "Search Engine"],
            figure: 1.66,
            label: "Email and Search Engine",
            size: 1.66
        }, {
            sets: ["Direct Traffic", "Search Engine"],
            figure: 2.4,
            label: "Direct Traffic and Search Engine",
            size: 2.4
        }, {
            sets: ["Email", "Direct Traffic", "Search Engine"],
            figure: 1.08,
            label: "Email, Direct Traffic, and Search Engine",
            size: 1.08
        }];

        var chart = venn
            .VennDiagram()
            .width(500)
            .height(400);

        var div2 = d3
            .select("#venn_two")
            .datum(sets)
            .call(chart);
        div2.selectAll("text").style("fill", "white");
        div2
            .selectAll(".venn-circle path")
            .style("fill-opacity", 0.8)
            .style("stroke-width", 1)
            .style("stroke-opacity", 1)
            .style("stroke", "fff");

        var tooltip = d3
            .select("body")
            .append("div")
            .attr("class", "venntooltip");

        div2
            .selectAll("g")
            .on("mouseover", function (d, i) {
                // sort all the areas relative to the current item
                venn.sortAreas(div2, d);

                // Display a tooltip with the current size
                tooltip
                    .transition()
                    .duration(40)
                    .style("opacity", 1);
                tooltip.text(d.size + "% media touchpoint " + d.label);

                // highlight the current path
                var selection = d3
                    .select(this)
                    .transition("tooltip")
                    .duration(400);
                selection
                    .select("path")
                    .style("stroke-width", 3)
                    .style("fill-opacity", d.sets.length == 1 ? 0.8 : 0)
                    .style("stroke-opacity", 1);
            })

            .on("mousemove", function () {
                tooltip
                    .style("left", d3.event.pageX + "px")
                    .style("top", d3.event.pageY - 28 + "px");
            })

            .on("mouseout", function (d, i) {
                tooltip
                    .transition()
                    .duration(2500)
                    .style("opacity", 0);
                var selection = d3
                    .select(this)
                    .transition("tooltip")
                    .duration(400);
                selection
                    .select("path")
                    .style("stroke-width", 3)
                    .style("fill-opacity", d.sets.length == 1 ? 0.8 : 0)
                    .style("stroke-opacity", 1);
            });
    }

    function personalityDiagram() {
        var width = 300,
            height = 300;

        // Config for the Radar chart
        var config = {
            w: width,
            h: height,
            maxValue: 100,
            levels: 5,
            ExtraWidthX: 300
        }

        var data = [
            [{
                "area": "Openness",
                "value": 80
            }, {
                "area": "Conscientiousness",
                "value": 40
            }, {
                "area": "Extraversion ",
                "value": 40
            }, {
                "area": "Agreeableness ",
                "value": 90
            }, {
                "area": "Neuroticism ",
                "value": 60
            }]
        ]

        //Call function to draw the Radar chart

        var svg = d3.select('chart_persornality')
            .append('svg')
            .attr("width", width)
            .attr("height", height);

        RadarChart.draw("#chart_persornality", data, config);
    }
    
    function loadProfileAttribution() {
        // set the dimensions and margins of the graph
        var containerW = Math.round($("#profile_attribution").width())
        var margin = { top: 30, right: 60, bottom: 100, left: 140 },
            width = containerW - margin.left - margin.right,
            height = 550 - margin.top - margin.bottom;

        // append the svg object to the body of the page
        var svg = d3.select("#profile_attribution")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        // Labels of row and columns
    
        var myGroups = ["Live_in_Saigon", "Visited_Web", "Installed_App", "Used_Credit_Card","Buy_Product"]
        var myVars = ["Buy_Product", "Used_Credit_Card", "Installed_App",  "Visited_Web", "Live_in_Saigon" ]

        // Build X scales and axis:
        var x = d3.scaleBand()
            .range([0, width])
            .domain(myGroups)
            .padding(0.01);
        svg.append("g")
            .attr("transform", "translate(0," + height + ")")
            .attr("class", "x_axis")
            .call(d3.axisBottom(x))
            .selectAll("text")
            .attr("transform", "translate(-10,10)rotate(-30)")
            .style("text-anchor", "end")
            .style("font-size", 15)
            .style("fill", "#E91E0D");

        // Build X scales and axis:
        var y = d3.scaleBand()
            .range([height, 0])
            .domain(myVars)
            .padding(0.01);
        svg.append("g")
            .attr("class", "y_axis")
            .call(d3.axisLeft(y))
            .selectAll("text")
            .style("text-anchor", "end")
            .style("font-size", 15)
            .style("fill", "#463CC4")
            ;

        // Build color scale
        var myColor = d3.scaleLinear()
            .range(["white", "#008748"])
            .domain([1, 100]);
        
        function select_axis_label(datum) {
            return d3.select('.x_axis')
            	.selectAll('text')
            	.filter(function(x) { return x == datum.letter; });
        }

        //Read the data
        var urlDataSource = "/public/uploaded-files/sample-profile-attribution.csv?_=" + new Date().getTime();
        d3.csv(urlDataSource, function (data) {
        	
            // Three function that change the tooltip when user hover / move / leave a cell

            var onclick = function (d) {
            	var str = " [Profile attribute: " + d.profile_attr + " - Persona attribute: " + d.persona_attr + "] : Matching Score = " + d.matching_score + " %";
                $('#attribution_description').text(str);
                var myNode = svg.select("#cell_"+ d.profile_attr + '_' + d.persona_attr);
            	
                var str = " [Profile attribute: " + d.profile_attr + " - Persona attribute: " + d.persona_attr + "] : Matching Score = " + d.matching_score + " %";
                $('#attribution_description').text(str).effect("highlight", {color:"#5eeb34"}, 6000 );
            }
           
            var mouseover = function (d) {
            	console.log(d)
            	var myNode = svg.select("#cell_"+ d.profile_attr + '_' + d.persona_attr);
            	myNode.style("fill", "#5eeb34");
            	
            	var str = " [Profile attribute: " + d.profile_attr + " - Persona attribute: " + d.persona_attr + "] : Matching Score = " + d.matching_score + " %";
                $('#attribution_description').text(str);
            }
            
            var mouseout = function(d) {
           		var myNode = svg.select("#cell_"+ d.profile_attr + '_' + d.persona_attr);
               	myNode.style("fill", myColor(d.matching_score) );
            }

            // add the squares
            svg.selectAll()
                .data(data, function (d) { return d.profile_attr + ':' + d.persona_attr; })
                .enter()
                .append("rect")
                .attr("id", function (d) { return "cell_"+ d.profile_attr + '_' + d.persona_attr })
                .attr("x", function (d) { return x(d.profile_attr) } )
                .attr("y", function (d) { return y(d.persona_attr) } )
                .attr("width", x.bandwidth())
                .attr("height", y.bandwidth())
                .style("fill", function (d) { return myColor(d.matching_score)} )
                .on("click", onclick)
                .on("mouseover", mouseover)
                .on('mouseout', mouseout)
                ;
        })
    }
</script>
